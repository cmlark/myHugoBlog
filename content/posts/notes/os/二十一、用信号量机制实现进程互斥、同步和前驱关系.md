---
title: 二十一、用信号量机制实现进程互斥、同步和前驱关系
tags: ["操作系统"]
categories: OS学习笔记
draft: false
date: 2022-04-27T19:48:11+08:00
---

#### 1.信号量机制实现进程互斥

1. 分析并发进程的关键活动，划定临界区（如：对临界资源打印机的访问就应放在临界区）
2. 设置**互斥信号量 mutex，初始值为 1**
3. 在临界区之前执行 P(mutex)
4. 在临界区之后执行 V(mutex)

<!--more-->

```c
//信号量机制实现互斥
semaphore mutex=1; //初始化信号量

P1(){
    ...
    P(mutex); //使用临界区资源前需要加锁
    临界代码区段....
    V(mutex); //使用临界区资源后需要解锁
    ...
}

P2(){
    ...
    P(mutex);
    临界代码区段....
    V(mutex);
    ...
}

//原理与上节类似
```

注意：**对不同的临界资源需要设置不同的互斥信号量。P，V 操作必须成对出现。**缺少 P(mutex)就不能保证临界区资源的互斥访问。缺少 V(mutex)会导致资源永不被释放，等待进程永不被唤醒。

![LLm4VH.png](https://s1.ax1x.com/2022/04/27/LLm4VH.png)

#### 2.信号量机制实现进程同步

进程同步：要让各并发进程按要求有序地推进

```c
//比如，P1、P2并发的执行，由于存在异步性，因此二者交替推进的次序是不确定的。
//若P2的“代码4”要基于P1的“代码1”和“代码2”的运行结果才能执行，那么我们就必须保证“代码4”一定是
//在“代码2”之后才会执行。
P1(){
    代码1;
    代码2;
    代码3;
}

P2(){
    代码4;
    代码5;
    代码6;
}
```

用信号量实现进程同步：

1. 分析什么地方需要实现“同步关系”，即必须保证“一前一后”执行的两个操作（或两句代码）
2. 设置**同步信号量 S，初始值为 0**。
3. **在“前操作”之后执行 V(S)；**
4. **在“后操作”之前执行 P(S)；**

```c
//信号量机制实现同步
semaphore S=0; //初始化同步信号量

P1(){
    代码1;
    代码2;
    V(S);
    代码3;
}

P2(){
    P(S);
    代码4;
    代码5;
    代码6;
}

/*
若先执行到V(S)操作，则S++后S=1.之后当执行到P(S)操作时，由于S=1，表示有可用资源，会执行S--，S的值变回0，P2的进程不会执行block原语，而是继续往下执行代码4.

若先执行到P(S)操作，由于S=0，S--后S=-1，表示此时没有可用资源，因此P操作中会执行block原语，主动请求阻塞。之后当执行完代码2，继而执行V(S)操作，S++，使S变回0由于此时有进程在该信号量对应的阻塞队列中，因此会在V操作中执行wakeup原语，唤醒P2进程。这样P2就可以继续执行代码4了。
这样就保证了代码4一定是在代码2之后执行。
*/


/*
这里有一点不理解。前面说过了同步信号量S=0时表示没有可用资源，但是如果先执行了P(S)操作，同步信号量S的值会变为-1并阻塞自己，当V(S)被执行后同步信号量S的值变为0并执行wakeup操作唤醒进程P2，若按照前面的陈述那么P2也会认为此时并没有可用资源，因为同步信号量S的值为0，这样P2进程不就饿死了吗？
不知道是不是我听漏了什么。
*/
```

#### 3.信号量机制实现前驱关系

进程 P1 中有句代码 S1，P2 中有句代码 S2 一直到 P6。这些代码要求按照如下前驱图所示的顺序来执行。

![LL3Vcn.png](https://s1.ax1x.com/2022/04/27/LL3Vcn.png)

每一对前驱关系都是一个进程同步问题（需要保证一前一后的操作）

因此：

1. 要**为每一对前驱关系各设置一个同步变量**a，b，c，d，e，f，g
2. **在“前操作”之后对相应的同步变量执行 V 操作**
3. **在“后操作”之前对相应的同步变量执行 P 操作**

```c
P1(){
    ...
    S1;
    V(a);
    V(B);
    ...
}
P2(){
    ...
    P(a);
    S2;
    V(c);
    V(d);
    ...
}
P3(){
    ...
    P(b);
    S3;
    V(g);
    ...
}
P4(){
    ...
    P(c);
    S4;
    V(e);
    ...
}
P5(){
    ...
    P(d);
    P(f);
    S5;
    V(f);
    ...
}
P6(){
    ...
    P(e);
    P(f);
    P(g);
    S6;
    ...
}
```

大概是这个样子：

![LL8rIU.png](https://s1.ax1x.com/2022/04/27/LL8rIU.png)

#### 4.知识回顾

![LLGPzj.png](https://s1.ax1x.com/2022/04/27/LLGPzj.png)
